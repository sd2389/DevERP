{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>DevERP Inventory</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="{% static 'inventory/index.css' %}" rel="stylesheet">
</head>

<div>
  <div class="container py-4">
    <div id="loading-overlay"
      class="position-fixed top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center bg-white bg-opacity-75"
      style="z-index: 1050;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <h1 class="text-center mb-4">Inventory</h1>

    <!-- Filters -->
    <div class="d-flex flex-wrap justify-content-center gap-2 mb-4">
      <input type="text" id="searchInput" class="form-control" placeholder="Search by design or job no."
        style="max-width:250px;">
      <div class="position-relative" style="max-width:200px; width:100%;">
        <select id="typeFilter" class="form-select">
          <option value="all">All Categories</option>
          <option value="earring">Earring</option>
          <option value="ring">Ring</option>
          <option value="necklace">Necklace</option>
          <option value="bracelet">Bracelet</option>
        </select>
      </div>
      <button class="filter-btn active" id="btn-all">All</button>
      <button class="filter-btn" id="btn-instock">In Stock</button>
      <button class="filter-btn" id="btn-notinstock">Not In Stock</button>
      <button class="btn btn-outline-primary" id="toggleViewBtn">Switch to Card View</button>
    </div>

    <!-- Toggle View -->
    <div class="d-flex justify-content-end mb-3">
    </div>
    <!-- Inventory Table -->
    <div id="table-view">
      <div class="table-responsive">
        <table class="table table-hover text-center align-middle" id="inventory-table">
          <thead class="table-secondary">
            <tr>
              <th>Sr No.</th>
              <th>Image</th>
              <th>Design No.</th>
              <th>Category</th>
              <th>No. of Pcs</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for prod in products %}
            <tr data-type="{{ prod.category|lower }}" data-status="{{ prod.status|lower }}"
              data-jobs="{% for job in prod.in_stock_jobs %}{{ job.job_no }} {% endfor %}"
              data-memojobs="{% for job in prod.memo_jobs %}{{ job.job_no }} {% endfor %}">

              <td>{{ forloop.counter }}</td>
              <td>
                <img src="{% static 'inventory/placeholder.jpg' %}"
                  data-src="https://dev-jewels.s3.us-east-2.amazonaws.com/products/{{ prod.design_no }}/White/D_{{ prod.design_no }}-1.jpg"
                  class="img-thumbnail lazy" style="height:60px; width:auto; cursor:pointer;" alt="Loading"
                  data-bs-toggle="modal" data-bs-target="#imageModal-{{ forloop.counter0 }}">
              </td>
              <td>{{ prod.design_no }}</td>
              <td>{{ prod.category }}</td>
              <td>
                <a href="#" class="pcs-btn" data-bs-toggle="modal" data-bs-target="#modal-{{ forloop.counter0 }}">
                  {{ prod.pcs }}
                </a>
              </td>
              <td>
                <span class="badge {% if prod.pcs > 0 %}bg-success{% else %}bg-danger{% endif %}">
                  {{ prod.status }}
                </span>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="py-4">No items found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- card View -->
    <div id="card-view" class="row g-3 d-none">
      {% for prod in products %}
      <div class="col-6 col-md-4 col-lg-2-5" data-type="{{ prod.category|lower }}" data-status="{{ prod.status|lower }}"
        data-jobs="{% for job in prod.jobs %}{{ job.job_no }} {% endfor %}">
        <div class="card h-auto shadow-sm p-2">
          <div class="card-img-container position-relative" style="padding-top: 100%; overflow: hidden;">
            <img class="position-absolute top-0 start-0 w-100 h-100 object-fit-contain lazy"
              src="{% static 'inventory/placeholder.jpg' %}"
              data-src="https://dev-jewels.s3.us-east-2.amazonaws.com/products/{{ prod.design_no }}/White/D_{{ prod.design_no }}-1.jpg"
              alt="{{ prod.design_no }}" data-bs-toggle="modal" data-bs-target="#imageModal-{{ forloop.counter0 }}">
          </div>

          <div class="card-body text-center">
            <h6 class="card-title">{{ prod.design_no }}</h6>
            <p class="mb-1 text-muted">{{ prod.category }}</p>
            <p class="mb-1">
              <a href="#" class="pcs-btn" data-bs-toggle="modal" data-bs-target="#modal-{{ forloop.counter0 }}">
                {{ prod.pcs }} pcs
              </a>
            </p>
            <span class="badge {% if prod.pcs > 0 %}bg-success{% else %}bg-danger{% endif %}">
              {{ prod.status }}
            </span>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Modals: moved out of table rows so Bootstrap can display them regardless of row visibility -->
    {% for prod in products %}
    <div class="modal fade" id="modal-{{ forloop.counter0 }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content rounded-4">
          <div class="modal-header">
            <h5 class="modal-title">Order: {{ prod.design_no }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            {% if prod.pcs > 0 %}
            <!-- ✅ In-Stock Jobs Section -->
            <h6 class="text-center mb-3 fw-bold">In Stock</h6>
            <div class="table-responsive mb-4">
              <table class="table table-bordered table-sm align-middle text-center">
                <thead class="table-light">
                  <tr>
                    <th>Select</th>
                    <th>Job No</th>
                    <th>Metal</th>
                    <th>Quality</th>
                    <th>Color</th>
                    <th>GWT</th>
                    <th>DWT</th>
                    <th>Size</th>
                    <th>Price</th>
                  </tr>
                </thead>
                <tbody>
                  {% for job in prod.in_stock_jobs %}
                  <tr>
                    <td>
                      <input type="checkbox" class="form-check-input job-checkbox" data-design="{{ prod.design_no }}"
                        data-job_no="{{ job.job_no }}" data-price="{{ job.discounted_price }}">

                    </td>
                    <td>{{ job.job_no }}</td>
                    <td>{{ job.metal_type }}</td>
                    <td>{{ job.metal_quality }}</td>
                    <td>{{ job.metal_color }}</td>
                    <td>{{ job.gwt }}</td>
                    <td>{{ job.dwt }}</td>
                    <td>{{ job.size }}</td>
                    <td>${{ job.discounted_price }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <!-- ❗ Original Out of Stock Message -->
            <p class="out-of-stock-msg">Sorry, we are out of stock.</p>
            <div class="contact-info">
              Contact us at <a href="mailto:abc@gmail.com">abc@gmail.com</a> or <a
                href="tel:+12011234567">+1 (201) 123 4567</a>
            </div>
            {% endif %}


            <!-- 📌 Memo Section -->
            {% if prod.memo_jobs %}
            <h6 class="text-center mb-3 fw-bold">On Memo with Others</h6>
            <div class="table-responsive mb-4">
              <table class="table table-bordered table-sm align-middle text-center">
                <thead class="table-light">
                  <tr>
                    <th>Request</th>
                    <th>Job No</th>
                    <th>Metal</th>
                    <th>Quality</th>
                    <th>Color</th>
                    <th>GWT</th>
                    <th>DWT</th>
                    <th>Size</th>
                    <th>Price</th>
                  </tr>
                </thead>
                <tbody>
                  {% for job in prod.memo_jobs %}
                  <tr>
                    <td>
                      <input type="checkbox" class="form-check-input memo-checkbox" data-design="{{ prod.design_no }}"
                        data-job_no="{{ job.job_no }}">
                    </td>
                    <td>{{ job.job_no }}</td>
                    <td>{{ job.metal_type }}</td>
                    <td>{{ job.metal_quality }}</td>
                    <td>{{ job.metal_color }}</td>
                    <td>{{ job.gwt }}</td>
                    <td>{{ job.dwt }}</td>
                    <td>{{ job.size }}</td>
                    <td>${{ job.discounted_price }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              <div class="text-end mt-3">
                <button class="btn btn-warning btn-sm request-selected-memo-btn">
                  Request Selected Memo Items
                </button>
              </div>
            </div>
            {% endif %}

            <!-- ✅ Custom Order Section (always shown) -->
            <h6 class="text-center mb-3 fw-bold">Custom Order</h6>
            <div class="table-responsive">
              <table class="table table-bordered table-sm align-middle text-center"
                id="customOrderTable-{{ forloop.counter0 }}">
                <thead class="table-light">
                  <tr>
                    <th>Serial No.</th>
                    <th>Metal Type</th>
                    <th>Quality</th>
                    <th>Color</th>
                    <th>Size (in)</th>
                    <th>Number of Pcs</th>
                    <th>Remove</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Custom rows inserted via JS -->
                </tbody>
              </table>
            </div>
            <button class="btn btn-sm btn-outline-primary mb-3 add-row-btn"
              onclick="addCustomRow('{{ forloop.counter0 }}', '{{ prod.design_no }}')">
              + Add Row
            </button>
          </div>

          <div class="modal-footer justify-content-between">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-dark" onclick="addToCart('{{ prod.design_no }}', '{{ forloop.counter0 }}')">Add to
              Cart</button>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}

    <!-- 📌 Image Modal -->
    {% for prod in products %}
    <div class="modal fade" id="imageModal-{{ forloop.counter0 }}" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Images - {{ prod.design_no }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3 text-center">
              <button class="btn btn-outline-secondary mx-1 color-btn" data-color="White"
                data-design="{{ prod.design_no }}" data-modal="{{ forloop.counter0 }}">W</button>
              <button class="btn btn-outline-secondary mx-1 color-btn" data-color="Yellow"
                data-design="{{ prod.design_no }}" data-modal="{{ forloop.counter0 }}">Y</button>
              <button class="btn btn-outline-secondary mx-1 color-btn" data-color="Rose"
                data-design="{{ prod.design_no }}" data-modal="{{ forloop.counter0 }}">R</button>
            </div>
            <div id="carousel-{{ forloop.counter0 }}" class="carousel slide" data-bs-ride="false">
              <div class="carousel-inner text-center" id="carousel-inner-{{ forloop.counter0 }}">
                <div class="carousel-item active">
                  <img
                    src="https://dev-jewels.s3.us-east-2.amazonaws.com/products/{{ prod.design_no }}/White/D_{{ prod.design_no }}-1.jpg"
                    class="modal-carousel-img d-inline-block" alt="{{ prod.design_no }}">
                </div>
              </div>
              <button class="carousel-control-prev" type="button" data-bs-target="#carousel-{{ forloop.counter0 }}"
                data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#carousel-{{ forloop.counter0 }}"
                data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
              </button>
            </div>


            <!-- <button class="carousel-control-prev" type="button" data-bs-target="#carousel-{{ forloop.counter0 }}"
              data-bs-slide="prev">
              <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carousel-{{ forloop.counter0 }}"
              data-bs-slide="next">
              <span class="carousel-control-next-icon"></span>
            </button> -->
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}


  <!-- ✨ Enhanced Memo Request Confirmation Modal -->
  <div class="modal fade" id="memoConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-lg">
        <div class="modal-header border-bottom-0">
          <h5 class="modal-title fw-semibold">
            <i class="bi bi-exclamation-circle text-warning me-2"></i>Memo Item Request
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <p class="mb-3">The following items are currently on memo with another customer:</p>
          <ul id="memoJobList" class="list-group mb-3 border rounded-2">
            <!-- Filled dynamically -->
          </ul>
          <div class="alert alert-warning small mb-0">
            Do you want to request these items? They will be saved in your "My Requests".
          </div>
        </div>

        <div class="modal-footer border-top-0 d-flex gap-2">
          <button class="btn btn-outline-secondary flex-fill" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i> Leave These Items
          </button>
          <button class="btn btn-primary flex-fill" id="proceedMemoItemsBtn" data-bs-dismiss="modal">
            <i class="bi bi-check-circle me-1"></i> Proceed
          </button>
        </div>
      </div>
    </div>
  </div>


  <!-- ✅ Toast Notification -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="cartToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive"
      aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          ✅ Item(s) added to cart successfully.
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
  </div>





  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const btnAll = document.getElementById('btn-all');
      const btnInStock = document.getElementById('btn-instock');
      const btnNotStock = document.getElementById('btn-notinstock');
      const searchInput = document.getElementById('searchInput');
      const typeFilter = document.getElementById('typeFilter');
      const overlay = document.getElementById('loading-overlay');

      const rows = Array.from(document.querySelectorAll('#inventory-table tbody tr')).map(tr => {
        const jobNos = ((tr.dataset.jobs || "") + " " + (tr.dataset.memojobs || "")).toLowerCase();
        return {
          el: tr,
          type: tr.dataset.type,
          status: tr.dataset.status,
          jobs: jobNos.split(/\s+/).filter(Boolean),
        };
      });



      let currentFilter = 'all';

      function debounce(fn, delay = 150) {
        let timer;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      // ✅ Updated Filter Logic for Both Table and Card View
      function applyFilters() {
        const query = searchInput.value.trim().toLowerCase();
        const cat = typeFilter.value.toLowerCase();

        // Loop through table rows
        rows.forEach(row => {
          const { el, type, status, jobs } = row;

          const designNo = el.querySelector("td:nth-child(3)")?.textContent.toLowerCase() || "";
          const category = el.querySelector("td:nth-child(4)")?.textContent.toLowerCase() || "";

          const matchesSearch =
            designNo.includes(query) ||
            category.includes(query) ||
            jobs.some(j => j.includes(query));

          const matchesCat = cat === "all" || type === cat;
          const matchesStat =
            currentFilter === "all" ||
            (currentFilter === "instock" && status === "in stock") ||
            (currentFilter === "notinstock" && status === "not in stock");

          el.style.display = matchesSearch && matchesCat && matchesStat ? "" : "none";
        });


        // Card View: Same logic
        const cards = document.querySelectorAll("#card-view .col-6");
        cards.forEach(card => {
          const text = card.innerText.toLowerCase();
          const type = card.dataset.type;
          const status = card.dataset.status;
          const jobs = (card.dataset.jobs || card.dataset.memojobs || "").toLowerCase();

          const matchesSearch = text.includes(query) || jobs.includes(query);
          const matchesCat = cat === "all" || type === cat;
          const matchesStat =
            currentFilter === "all" ||
            (currentFilter === "instock" && status === "in stock") ||
            (currentFilter === "notinstock" && status === "not in stock");

          card.style.display = matchesSearch && matchesCat && matchesStat ? "" : "none";
        });
      }


      // ✅ Wrapper function to show loading spinner
      function applyFiltersWithLoading() {
        overlay.classList.remove('d-none'); // Show loading
        setTimeout(() => {
          applyFilters();
          overlay.classList.add('d-none');  // Hide loading
        }, 400); // Adjust delay if needed (e.g. 300-500ms)
      }

      // ✅ Hook filter buttons
      [btnAll, btnInStock, btnNotStock].forEach(btn => {
        btn.addEventListener('click', () => {
          btnAll.classList.remove('active');
          btnInStock.classList.remove('active');
          btnNotStock.classList.remove('active');
          btn.classList.add('active');
          currentFilter = btn.id.replace('btn-', '');
          applyFiltersWithLoading();
        });
      });

      // ✅ Hook input + dropdown
      searchInput.addEventListener('input', debounce(applyFiltersWithLoading, 100));
      typeFilter.addEventListener('change', applyFiltersWithLoading);

      // Dynamic Carousel Image Loader
      document.querySelectorAll('.color-btn').forEach(button => {
        button.addEventListener('click', () => {
          const designNo = button.getAttribute('data-design');
          const color = button.getAttribute('data-color');
          const modalId = button.getAttribute('data-modal');
          const container = document.getElementById(`carousel-inner-${modalId}`);
          const baseUrl = `https://dev-jewels.s3.us-east-2.amazonaws.com/products/${designNo}/${color}/`;

          const imagePaths = [
            `D_${designNo}-1.jpg`,
            `H_${designNo}-2.jpg`,
            `${designNo}-3.jpg`,
            `${designNo}-4.jpg`
          ];

          let content = '';
          imagePaths.forEach((name, idx) => {
            content += `
        <div class="carousel-item ${idx === 0 ? 'active' : ''}">
          <img src="${baseUrl}${name}" class="modal-carousel-img d-inline-block" alt="${color} image ${idx + 1}">
        </div>`;
          });
          container.innerHTML = content;
        });
      });
    });
  </script>

  <!-- Lazy Loading -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const lazyImages = document.querySelectorAll("img.lazy");

      if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries, obs) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;

              // Prevent double-loading
              if (img.dataset.src && !img.dataset.loaded) {
                img.src = img.dataset.src;
                img.dataset.loaded = "true";  // mark as loaded
                img.classList.remove("lazy");
                obs.unobserve(img);
              }
            }
          });
        });

        lazyImages.forEach(img => observer.observe(img));
      } else {
        // fallback for unsupported browsers
        lazyImages.forEach(img => {
          img.src = img.dataset.src;
        });
      }
    });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const toggleBtn = document.getElementById("toggleViewBtn");
      const tableView = document.getElementById("table-view");
      const cardView = document.getElementById("card-view");

      toggleBtn.addEventListener("click", () => {
        tableView.classList.toggle("d-none");
        cardView.classList.toggle("d-none");
        toggleBtn.textContent = tableView.classList.contains("d-none")
          ? "Switch to Table View"
          : "Switch to Card View";
      });
    });
  </script>

  <!-- Zoom -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      function initZoom(container) {
        const img = container.querySelector(".zoom-img");
        const lens = container.querySelector(".zoom-lens");

        if (!img || !lens) return;

        lens.style.backgroundImage = `url('${img.src}')`;

        container.addEventListener("mousemove", function (e) {
          const rect = img.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          const lensSize = lens.offsetWidth / 2;

          // Constrain lens within image
          const left = Math.max(0, Math.min(x - lensSize, img.clientWidth - lens.offsetWidth));
          const top = Math.max(0, Math.min(y - lensSize, img.clientHeight - lens.offsetHeight));

          lens.style.left = `${left}px`;
          lens.style.top = `${top}px`;
          lens.style.visibility = 'visible';

          const scaleX = img.naturalWidth / img.clientWidth;
          const scaleY = img.naturalHeight / img.clientHeight;
          lens.style.backgroundPosition = `-${left * scaleX}px -${top * scaleY}px`;
        });

        container.addEventListener("mouseleave", () => {
          lens.style.visibility = "hidden";
        });
      }

      // Initialize zoom on existing modal images
      document.querySelectorAll(".zoom-container").forEach(initZoom);

      // If your images are added dynamically (via JS), run initZoom when modal opens
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('shown.bs.modal', () => {
          modal.querySelectorAll(".zoom-container").forEach(initZoom);
        });
      });
    });
  </script>

  <!-- Custom Order -->
  <script>
    // Dynamically add a custom order row
    function addCustomRow(modalId, designNo) {

      const table = document.querySelector(`#customOrderTable-${modalId} tbody`);
      const rowIndex = table.rows.length + 1;
      const rowId = `custom-row-${modalId}-${rowIndex}`;

      const row = document.createElement('tr');
      row.setAttribute("id", rowId);
      row.innerHTML = `
      <td>${rowIndex}</td>
      <td>
        <select class="form-select form-select-sm" name="metal_type">
          <option value="Gold" selected>Gold</option>
          <option value="Platinum">Platinum</option>
        </select>
      </td>
      <td>
        <select class="form-select form-select-sm" name="metal_quality">
          <option value="14k" selected>14k</option>
          <option value="18k">18k</option>
        </select>
      </td>
      <td>
        <select class="form-select form-select-sm" name="metal_color">
          <option value="W" selected>White</option>
          <option value="Y">Yellow</option>
          <option value="R">Rose</option>
        </select>
      </td>
      <td><input type="number" min="1" max="100" class="form-control form-control-sm" name="size" placeholder="e.g. 6.5" required></td>
      <td><input type="number" min="1" max="100" class="form-control form-control-sm" name="qty" placeholder="Qty" required></td>
      <td>
        <button class="btn btn-sm btn-danger" onclick="removeCustomRow('${rowId}')">
          &times;
        </button>
      </td>
    `;

      table.appendChild(row);
    }

    function removeCustomRow(rowId) {
      const row = document.getElementById(rowId);
      if (row) {
        if (confirm("Are you sure you want to remove this row?")) {
          row.remove();
        }
      }
    }
  </script>

  <!-- Request Selected -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      let selectedMemoJobs = [];

      // ✅ Handle memo request button
      document.querySelectorAll(".request-selected-memo-btn").forEach(button => {
        button.addEventListener("click", () => {
          const modal = button.closest(".modal");
          const checkboxes = modal.querySelectorAll(".memo-checkbox:checked");

          if (checkboxes.length === 0) {
            alert("Please select at least one memo item.");
            return;
          }

          // ✅ Collect selected jobs using data-job_no (no regex, no parsing)
          selectedMemoJobs = Array.from(checkboxes).map(chk => ({
            design_no: chk.dataset.design,
            job_no: chk.dataset.job_no
          }));

          // ✅ Render job list in confirmation modal
          const jobList = document.getElementById("memoJobList");
          jobList.innerHTML = selectedMemoJobs.map(j =>
            `<li class="list-group-item">${j.design_no} – Job ${j.job_no}</li>`
          ).join("");

          // ✅ Show the modal
          const confirmModal = new bootstrap.Modal(document.getElementById("memoConfirmModal"));
          confirmModal.show();
        });
      });

      // ✅ Proceed button saves to localStorage
      document.getElementById("proceedMemoItemsBtn").addEventListener("click", () => {
        let memoRequests = JSON.parse(localStorage.getItem("memoRequests") || "[]");

        selectedMemoJobs.forEach(job => {
          if (!memoRequests.some(j => j.job_no === job.job_no && j.design_no === job.design_no)) {
            memoRequests.push({
              ...job,
              requested_at: new Date().toISOString()
            });
          }
        });

        localStorage.setItem("memoRequests", JSON.stringify(memoRequests));
        alert("Memo request saved.");
      });
    });
  </script>


  <script>
    function addToCart(designNo, modalId) {
      const modal = document.getElementById(`modal-${modalId}`);
      const checkboxes = modal.querySelectorAll(".job-checkbox:checked");

      if (checkboxes.length === 0) {
        alert("Please select at least one item.");
        return;
      }

      const selectedJobs = Array.from(checkboxes).map(chk => ({
        design_no: chk.dataset.design,
        job_no: chk.dataset.job_no,
        qty: 1,
        price: parseFloat(chk.dataset.price || 0)
        
      }));


      const cartKey = "cart_customer";
      const existing = JSON.parse(localStorage.getItem(cartKey) || "[]");

      selectedJobs.forEach(job => {
        if (!existing.some(j => j.job_no === job.job_no && j.design_no === job.design_no)) {
          existing.push(job);
        }
      });

      localStorage.setItem(cartKey, JSON.stringify(existing));
      const totalQty = selectedJobs.reduce((sum, job) => sum + (parseInt(job.qty) || 1), 0);
      const toastEl = document.getElementById("cartToast");
      const toastBody = toastEl.querySelector(".toast-body");
      toastBody.textContent = `✅ ${totalQty} item(s) added to cart successfully.`;

      const toast = new bootstrap.Toast(toastEl);
      toast.show();

    }
  </script>

  </body>

</html>